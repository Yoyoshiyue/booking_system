<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»†èƒé—´ - äº‘ç«¯é¢„çº¦ç³»ç»Ÿ</title>
    <script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ï¼Œä»…å¢åŠ åŠ è½½ä¸­çš„æ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #c7d2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; color: #312e81; margin-bottom: 30px; font-size: 28px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 20px; }
        h2 { color: #1f2937; margin-bottom: 20px; font-size: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 14px; }
        .desk-buttons { display: flex; gap: 16px; }
        .desk-btn { flex: 1; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; font-size: 16px; }
        .desk-btn:hover { border-color: #818cf8; }
        .desk-btn.active { border-color: #4f46e5; background: #eef2ff; color: #4f46e5; }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
        input:focus, select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .submit-btn { width: 100%; padding: 12px; background: #4f46e5; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .submit-btn:hover { background: #4338ca; }
        .submit-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .message { padding: 12px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .message.success { background: #d1fae5; color: #065f46; }
        .message.error { background: #fee2e2; color: #991b1b; }
        .booking-item { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .booking-item:hover { background: #f9fafb; }
        .booking-info .desk { font-weight: 600; color: #4f46e5; font-size: 18px; }
        .booking-info .details { color: #6b7280; font-size: 14px; margin-top: 4px; }
        .cancel-btn { padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .cancel-btn:hover { background: #dc2626; }
        .empty-state { text-align: center; color: #9ca3af; padding: 40px 0; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading { text-align: center; color: #6b7280; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç»†èƒé—´ - é¢„çº¦ç³»ç»Ÿ (äº‘ç«¯åŒæ­¥ç‰ˆ)</h1>
        
        <div class="card">
            <h2>æ–°å»ºé¢„çº¦</h2>
            <div id="message"></div>
            
            <div class="form-group">
                <label>é€‰æ‹©æ¡Œå­</label>
                <div class="desk-buttons">
                    <button class="desk-btn" onclick="selectDesk('å·¦æ¡Œå­')">å·¦æ¡Œå­</button>
                    <button class="desk-btn" onclick="selectDesk('å³æ¡Œå­')">å³æ¡Œå­</button>
                </div>
            </div>

            <div class="form-group">
                <label>é¢„çº¦æ—¥æœŸ</label>
                <input type="date" id="date">
            </div>

            <div class="form-group">
                <label>æ—¶é—´æ®µ</label>
                <select id="time">
                   <option value="">è¯·é€‰æ‹©æ—¶é—´æ®µ</option>
                    <option value="08:00-09:00">08:00-09:00</option>
                    <option value="09:00-10:00">09:00-10:00</option>
                    <option value="10:00-11:00">10:00-11:00</option>
                    <option value="11:00-12:00">11:00-12:00</option>
                    <option value="12:00-13:00">12:00-13:00</option>
                    <option value="13:00-14:00">13:00-14:00</option>
                    <option value="14:00-15:00">14:00-15:00</option>
                    <option value="15:00-16:00">15:00-16:00</option>
                    <option value="16:00-17:00">16:00-17:00</option>
                    <option value="17:00-18:00">17:00-18:00</option>
                    <option value="18:00-19:00">18:00-19:00</option>
                    <option value="19:00-20:00">19:00-20:00</option>
                    <option value="20:00-21:00">20:00-21:00</option>
                    <option value="21:00-22:00">21:00-22:00</option>
                    <option value="22:00-23:00">22:00-23:00</option>
                    <option value="23:00-24:00">23:00-24:00</option>
                </select>
            </div>

            <div class="form-group">
                <label>é¢„çº¦äººå§“å</label>
                <input type="text" id="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
            </div>

            <button class="submit-btn" id="submitBtn" onclick="submitBooking()">æäº¤é¢„çº¦</button>
        </div>

        <div class="card">
            <h2>å½“å‰é¢„çº¦ (å®æ—¶åŒæ­¥)</h2>
            <div id="bookingList">
                <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        // è¯·å» LeanCloud (leancloud.cn) æ³¨å†Œè´¦å·ï¼Œåˆ›å»ºåº”ç”¨
        // åœ¨ è®¾ç½® > åº”ç”¨å‡­è¯ ä¸­æ‰¾åˆ° AppID å’Œ AppKey å¡«å…¥ä¸‹æ–¹
        const APP_ID = 'qmXzXEoaery3zmwWfGYraJkm-MdYXbMMI'; 
        const APP_KEY = 'DQw07FENKXA4KRNHsTPIozDy'; 
        
        // å»ºè®®ï¼šå¦‚æœä½ åªæ˜¯å®éªŒå®¤å†…éƒ¨å°èŒƒå›´ç”¨ï¼Œä¸æƒ³é…ç½®åŸŸåï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ LeanCloud å›½é™…ç‰ˆ æˆ–è€…å…¶ä»–ç±»ä¼¼æœåŠ¡(å¦‚ Firebase)
        // ä¸‹é¢çš„åˆå§‹åŒ–ä»£ç å‡è®¾ä½ ä½¿ç”¨çš„æ˜¯ LeanCloud å›½é™…ç‰ˆæˆ–è€…å·²é…ç½®å¥½åŸŸåçš„å›½å†…ç‰ˆ
        
        if (APP_ID === 'qmXzXEoaery3zmwWfGYraJkm-MdYXbMMI') {
            alert("è¯·åœ¨ä»£ç ä¸­å¡«å†™ LeanCloud çš„ App ID å’Œ App Key æ‰èƒ½å®ç°äº‘åŒæ­¥ï¼");
        }

        AV.init({
            appId: APP_ID,
            appKey: APP_KEY
        });

        // ==========================================

        let selectedDesk = '';
        
        // è®¾ç½®æœ€å°æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('date').min = new Date().toISOString().split('T')[0];

        function selectDesk(desk) {
            selectedDesk = desk;
            document.querySelectorAll('.desk-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === desk);
            });
        }

        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => msgDiv.innerHTML = '', 3000);
        }

        async function submitBooking() {
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const userName = document.getElementById('userName').value;
            const btn = document.getElementById('submitBtn');

            if (!selectedDesk || !date || !time || !userName) {
                showMessage('è¯·å¡«å†™æ‰€æœ‰ä¿¡æ¯', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æäº¤ä¸­...';

            try {
                // 1. æ£€æŸ¥æ˜¯å¦å·²è¢«é¢„çº¦ (äº‘ç«¯æŸ¥è¯¢)
                const query = new AV.Query('Booking');
                query.equalTo('desk', selectedDesk);
                query.equalTo('date', date);
                query.equalTo('time', time);
                const count = await query.count();

                if (count > 0) {
                    showMessage('è¯¥æ—¶æ®µå·²è¢«ä»–äººé¢„çº¦ï¼Œè¯·åˆ·æ–°æŸ¥çœ‹', 'error');
                    await fetchBookings(); // åˆ·æ–°åˆ—è¡¨
                    return;
                }

                // 2. ä¿å­˜åˆ°äº‘ç«¯
                const Booking = AV.Object.extend('Booking');
                const booking = new Booking();
                booking.set('desk', selectedDesk);
                booking.set('date', date);
                booking.set('time', time);
                booking.set('userName', userName);
                
                await booking.save();
                
                showMessage('é¢„çº¦æˆåŠŸï¼', 'success');
                
                // é‡ç½®è¡¨å•
                selectedDesk = '';
                document.querySelectorAll('.desk-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('date').value = '';
                document.getElementById('time').value = '';
                document.getElementById('userName').value = '';
                
                // åˆ·æ–°åˆ—è¡¨
                await fetchBookings();

            } catch (error) {
                console.error(error);
                showMessage('é¢„çº¦å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æäº¤é¢„çº¦';
            }
        }

        async function cancelBooking(objectId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªé¢„çº¦å—ï¼Ÿ')) return;

            try {
                const todo = AV.Object.createWithoutData('Booking', objectId);
                await todo.destroy();
                showMessage('å·²å–æ¶ˆé¢„çº¦', 'success');
                await fetchBookings();
            } catch (error) {
                showMessage('å–æ¶ˆå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        async function fetchBookings() {
            const listDiv = document.getElementById('bookingList');
            
            try {
                const query = new AV.Query('Booking');
                // æŒ‰æ—¥æœŸæ’åº
                query.ascending('date');
                query.addAscending('time');
                // åªæ˜¾ç¤ºä»Šå¤©çš„å’Œæœªæ¥çš„é¢„çº¦
                // query.greaterThanOrEqualTo('date', new Date().toISOString().split('T')[0]); 
                
                const results = await query.find();
                
                if (results.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state">æš‚æ— é¢„çº¦è®°å½•</div>';
                    return;
                }

                listDiv.innerHTML = results.map(booking => {
                    const data = booking.attributes;
                    const id = booking.id;
                    return `
                        <div class="booking-item">
                            <div class="booking-info">
                                <div class="desk">${data.desk}</div>
                                <div class="details">
                                    ğŸ“… ${data.date} â° ${data.time}<br>
                                    ğŸ‘¤ é¢„çº¦äºº: ${data.userName}
                                </div>
                            </div>
                            <button class="cancel-btn" onclick="cancelBooking('${id}')">å–æ¶ˆ</button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                listDiv.innerHTML = `<div class="empty-state" style="color:red">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–AppKeyé…ç½®</div>`;
                console.error(error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‹‰å–æ•°æ®
        fetchBookings();
    </script>
</body>
</html>
